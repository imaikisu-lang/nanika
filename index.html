<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Perfect Start Runner</title>
    <style>
        body { background: #111; color: white; text-align: center; font-family: sans-serif; overflow: hidden; }
        #game { position: relative; width: 400px; height: 500px; margin: 20px auto; background: #222; border: 4px solid #444; overflow: hidden; }
        #player { position: absolute; left: 50px; width: 30px; height: 30px; background: #ffea00; border-radius: 4px; display: none; }
        .wall { position: absolute; right: -50px; width: 50px; background: #ff4757; }
        
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        button { padding: 15px 40px; font-size: 20px; cursor: pointer; background: #2ed573; border: none; border-radius: 50px; color: white; font-weight: bold; box-shadow: 0 4px #1a944d; }
        button:active { transform: translateY(2px); box-shadow: 0 2px #1a944d; }
    </style>
</head>
<body>
    <div id="score">0m 進んだ</div>
    <div id="game">
        <div id="start-screen">
            <h2 style="margin-bottom:20px;">Flappy Heart</h2>
            <p style="color:#aaa; margin-bottom:30px;">クリックで浮上。壁を避けろ。</p>
            <button id="start-button">旅を始める</button>
        </div>
        <div id="player"></div>
    </div>

    <script>
        const playerEl = document.getElementById('player');
        const game = document.getElementById('game');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        
        // ゲームの数値を初期化
        let py = 250, velocity = 0, score = 0, frames = 0;
        let walls = [];
        let isPlaying = false; 
        const gravity = 0.4, jump = -7;

        // 【スタートボタンの処理】
        startButton.addEventListener('click', (e) => {
            e.stopPropagation(); // 背景のジャンプ判定を無効化
            startGame();
        });

        function startGame() {
            // 全ての数値をリセットしてから開始
            isPlaying = true;
            py = 250;
            velocity = 0;
            score = 0;
            frames = 0;
            walls = [];
            
            // 画面表示の切り替え
            startScreen.style.display = 'none';
            playerEl.style.display = 'block';
            
            // ここで初めてループを回し始める
            requestAnimationFrame(update);
        }

        function update() {
            if (!isPlaying) return; // プレイ中じゃなければ即終了

            // 1. 重力計算
            velocity += gravity;
            py += velocity;
            playerEl.style.top = py + 'px';

            // 2. 壁の生成（ボタンを押してからの経過時間で計算）
            frames++;
            if (frames % 100 === 0) {
                const gapTop = Math.random() * 250 + 50;
                createWall(gapTop);
            }

            // 3. 壁の移動と判定
            for (let i = walls.length - 1; i >= 0; i--) {
                let w = walls[i];
                w.x -= 3;
                w.topEl.style.left = w.x + 'px';
                w.botEl.style.left = w.x + 'px';

                // 当たり判定
                if (w.x < 80 && w.x > 20) {
                    if (py < w.gap || py + 30 > w.gap + 120) {
                        gameOver();
                        return;
                    }
                }

                // スコア加算と削除
                if (w.x < -50) {
                    w.topEl.remove(); w.botEl.remove();
                    walls.splice(i, 1);
                    score++;
                    document.getElementById('score').innerText = score + "m 進んだ";
                }
            }

            // 落下・上昇しすぎ判定
            if (py > 470 || py < 0) { 
                gameOver(); 
                return;
            }

            requestAnimationFrame(update);
        }

        function gameOver() {
            isPlaying = false;
            alert("旅が終わりました。記録: " + score + "m");
            location.reload(); // ページをリロードして初期状態に戻す
        }

        function createWall(gap) {
            const top = document.createElement('div');
            top.className = 'wall'; top.style.top = '0'; top.style.height = gap + 'px';
            const bot = document.createElement('div');
            bot.className = 'wall'; bot.style.top = (gap + 120) + 'px'; bot.style.height = '500px';
            game.appendChild(top); game.appendChild(bot);
            walls.push({ x: 400, gap: gap, topEl: top, botEl: bot });
        }

        // 入力イベント（プレイ中のみ有効）
        window.addEventListener('mousedown', () => { if(isPlaying) velocity = jump; });
        window.addEventListener('keydown', (e) => { if(e.code==='Space' && isPlaying) velocity = jump; });
    </script>
</body>
</html>
